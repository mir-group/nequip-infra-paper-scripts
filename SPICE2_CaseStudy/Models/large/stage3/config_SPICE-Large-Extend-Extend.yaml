run: [train,val,test]
num_nodes: 8


cutoff_radius: 6.0
chemical_symbols: ["B","Br","C","Cl","F","H","I","K","Li","N","Na","O","P","S","Si"]
model_type_names: ${chemical_symbols}

#Specify Run Name:
logger_name: SPICE-Large-Extend-Extend

#Specify Model Hyperparameters:
model_seed: 1024
model_dtype: float32

#Assumes bessel embedding
model_numbessels: 8
model_bessel_trainable: false
model_polynomial_cutoff_p: 6
model_two_body_embedding_dim: 32
model_two_body_mlp_hidden_layers_depth: 2
model_two_body_mlp_hidden_layers_width: 64
model_two_body_mlp_nonlinearity: silu

#Assumes Spline Embedding
#model_num_splines: MODELNUMSPLINESBLANK
#model_spline_span: MODELSPLINESPANBLANK

model_scalar_embed_output_dim: 128

model_lmax: 3
model_parity: o3_full
model_numlayers: 3

model_num_scalar_features: 128
model_num_tensor_features: 128

model_allegro_mlp_hidden_layers_depth: 3
model_allegro_mlp_hidden_layers_width: 512
model_allegro_mlp_nonlinearity: silu

model_readout_mlp_hidden_layers_depth: 1
model_readout_mlp_hidden_layers_width: 128
model_readout_mlp_nonlinearity: null

#Specify Training Hyperparameters:
batch_size: 4

ema_decay: 0.999

model_tp_path_channel_coupling: true
model_forward_normalize: true

earlystopping_min_delta: 0.000000001
earlystopping_patience: 200

loss_force_weight: 1
loss_energyatom_weight: 25

optimizer_lr: 0.001
optimizer_amsgrad: false

lr_scheduler_factor: 0.8
lr_scheduler_patience: 10
lr_scheduler_threshold: 0.000001
lr_scheduler_minlr: 0.0000001

allow_tf32: false
seed: 901



data:
  _target_: nequip.data.datamodule.NequIPDataModule
  seed: ${seed} #42022024             # dataset seed for reproducibility
  
  train_dataset:
    _target_: nequip.data.dataset.NequIPLMDBDataset
    file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-2.0.1-processed_element-types_all_within-6.0_0-totalcharge_use-dfttotalenergy_units-eV-A_train.lmdb 
    transforms:
        # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
      - _target_: nequip.data.transforms.NeighborListTransform
        r_max: ${cutoff_radius}
        # the models only know atom types, which can be different from the chemical species (e.g. C, H)
        # for instance we can have data with different charge states of carbon, which means they are
        # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
        # in this case, the atom types are the same as the chemical species, but we still have to include this
        # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
      - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
        chemical_symbols: ${chemical_symbols}
  val_dataset:
    _target_: nequip.data.dataset.NequIPLMDBDataset
    file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-2.0.1-processed_element-types_all_within-6.0_0-totalcharge_use-dfttotalenergy_units-eV-A_val.lmdb 
    transforms:
        # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
      - _target_: nequip.data.transforms.NeighborListTransform
        r_max: ${cutoff_radius}
        # the models only know atom types, which can be different from the chemical species (e.g. C, H)
        # for instance we can have data with different charge states of carbon, which means they are
        # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
        # in this case, the atom types are the same as the chemical species, but we still have to include this
        # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
      - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
        chemical_symbols: ${chemical_symbols}
  test_dataset:
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-2.0.1-processed_element-types_all_within-6.0_0-totalcharge_use-dfttotalenergy_units-eV-A_test.lmdb 
      transforms:
        # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
          # the models only know atom types, which can be different from the chemical species (e.g. C, H)
          # for instance we can have data with different charge states of carbon, which means they are
          # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
          # in this case, the atom types are the same as the chemical species, but we still have to include this
          # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-test-processed_element-types_all_within-6.0_0-totalcharge_use-dfttotalenergy_units-eV-A.lmdb
      transforms:
          # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
          # the models only know atom types, which can be different from the chemical species (e.g. C, H)
          # for instance we can have data with different charge states of carbon, which means they are
          # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
          # in this case, the atom types are the same as the chemical species, but we still have to include this
          # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-test-processed_element-types_all_within-6.0_all-totalcharge_use-dfttotalenergy_units-eV-A.lmdb
      transforms:
          # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
          # the models only know atom types, which can be different from the chemical species (e.g. C, H)
          # for instance we can have data with different charge states of carbon, which means they are
          # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
          # in this case, the atom types are the same as the chemical species, but we still have to include this
          # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy-NeutralAtoms/03_CombineAndLMDB/SPICE-test-processed_element-types_all_within-6.0_0-totalcharge_0-formalcharge_use-dfttotalenergy_units-eV-A.lmdb
      transforms:
          # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
          # the models only know atom types, which can be different from the chemical species (e.g. C, H)
          # for instance we can have data with different charge states of carbon, which means they are
          # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
          # in this case, the atom types are the same as the chemical species, but we still have to include this
          # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
        #Put val dataset here so that we can get a predicted xyz file from it.
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SPICE-2.0.1-processed_element-types_all_within-6.0_0-totalcharge_use-dfttotalenergy_units-eV-A_val.lmdb
      transforms:
        # data doesn't usually come with a neighborlist -- this tranforms prepares the neighborlist
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        # the models only know atom types, which can be different from the chemical species (e.g. C, H)
        # for instance we can have data with different charge states of carbon, which means they are
        # all labeled by chemical species `C`, but may have different atom type labels based on the charge states
        # in this case, the atom types are the same as the chemical species, but we still have to include this
        # transformation to ensure that the data has 0-indexed atom type lists used in the various model operations
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    #0 total, 0 formal
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_0-formalcharge_use-dfttotalenergy_units-eV-A_small.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_0-formalcharge_use-dfttotalenergy_units-eV-A_large.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_0-formalcharge_use-dfttotalenergy_units-eV-A_pentapeptides.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    #0 total charge:
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_use-dfttotalenergy_units-eV-A_small.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_use-dfttotalenergy_units-eV-A_large.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_0-totalcharge_use-dfttotalenergy_units-eV-A_pentapeptides.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    #all total charge:
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_all-totalcharge_use-dfttotalenergy_units-eV-A_small.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_all-totalcharge_use-dfttotalenergy_units-eV-A_large.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-processed_element-types_all-totalcharge_use-dfttotalenergy_units-eV-A_pentapeptides.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-2-processed_element-types_0-totalcharge_0-formalcharge_use-dfttotalenergy_units-eV-A_dimers.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-2-processed_element-types_0-totalcharge_use-dfttotalenergy_units-eV-A_dimers.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-test-2-processed_element-types_all-totalcharge_use-dfttotalenergy_units-eV-A_dimers.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
    - _target_: nequip.data.dataset.NequIPLMDBDataset
      file_path: /lustre/orion/mat281/proj-shared/24_11_04_BigData/SPICE-2/Revise-TotalEnergy/03_CombineAndLMDB/SegmentedTest/SPICE-torsion-processed_element-types_all-totalcharge_use-dfttotalenergy_units-eV-A.lmdb
      transforms:
        - _target_: nequip.data.transforms.NeighborListTransform
          r_max: ${cutoff_radius}
        - _target_: nequip.data.transforms.ChemicalSpeciesToAtomTypeMapper
          chemical_symbols: ${chemical_symbols}
          
  train_dataloader:
    _target_: torch.utils.data.DataLoader
    batch_size: ${batch_size}
    num_workers: 7
    shuffle: true
  val_dataloader:
    _target_: torch.utils.data.DataLoader
    batch_size: ${batch_size}
    num_workers: ${data.train_dataloader.num_workers}
    shuffle: false
  test_dataloader: ${data.val_dataloader}
  #stats_manager:
  #  _target_: nequip.data.DataStatisticsManager
  #  dataloader_kwargs:
  #    batch_size: ${batch_size}
  #  metrics:
  #    - field:
  #        _target_: nequip.data.NumNeighbors
  #      metric: 
  #        _target_: nequip.data.Mean
  #      name: num_neighbors_mean
  #    - field:
  #        _target_: nequip.data.PerAtomModifier
  #        field: total_energy
  #      metric:
  #        _target_: nequip.data.Mean
  #      name: per_atom_energy_mean
  #    - field: forces
  #      metric:
  #        _target_: nequip.data.RootMeanSquare
  #      per_type: true
  #      name: per_type_forces_rms
  #      ignore_nan: true
  
trainer:
  _target_: lightning.Trainer
  max_epochs: 200
  check_val_every_n_epoch: 1
  log_every_n_steps: 50
  num_nodes: ${num_nodes}
  strategy: 
    _target_: nequip.train.SimpleDDPStrategy
    process_group_backend: gloo
  callbacks:
    - _target_: lightning.pytorch.callbacks.LearningRateMonitor
      logging_interval: epoch

    # to log the loss coefficients
    - _target_: nequip.train.callbacks.LossCoefficientMonitor
      interval: epoch
      frequency: 1
    - _target_: nequip.train.callbacks.TestTimeXYZFileWriter
      out_file: ${hydra:runtime.output_dir}/test
      output_fields_from_original_dataset: [total_energy, forces,subset]
      chemical_symbols: ${chemical_symbols}
    - _target_: lightning.pytorch.callbacks.EarlyStopping
      monitor: val0_epoch/weighted_sum        # validation metric to monitor
      min_delta: ${earlystopping_min_delta}                         # how much to be considered a "change"
      patience: ${earlystopping_patience}                            # how many instances of "no change" before stopping
      verbose: True
    # checkpoint based on some criterion
    - _target_: lightning.pytorch.callbacks.ModelCheckpoint
      monitor: val0_epoch/weighted_sum        # validation metric to monitor
      dirpath: ${hydra:runtime.output_dir}    # use hydra output directory
      filename: best                          # best.ckpt is the checkpoint name
      save_last: true                         # last.ckpt will be saved
    
  logger:
    # Lightning wandb logger https://lightning.ai/docs/pytorch/stable/api/lightning.pytorch.loggers.wandb.html#module-lightning.pytorch.loggers.wandb
    _target_: lightning.pytorch.loggers.wandb.WandbLogger
    project: SPICE-2_Frontier
    name: ${logger_name}
    version: ${logger_name} 
    save_dir: ${hydra:runtime.output_dir}  # use resolver to place wandb logs in hydra's output directory    

training_module:
  _target_: nequip.train.EMALightningModule
  loss:
    _target_: nequip.train.MetricsManager
    metrics:
      - name: force_MSE
        field: forces
        coeff: ${loss_force_weight}
        metric:
          _target_: nequip.train.MeanSquaredError
      - name: peratom_E_MSE
        field:
          _target_: nequip.data.PerAtomModifier
          field: total_energy
        coeff: ${loss_energyatom_weight}
        metric:
          _target_: nequip.train.MeanSquaredError
  val_metrics: 
    _target_: nequip.train.MetricsManager
    type_names: ${model_type_names}
    metrics:
      - name: F_RMSE
        field: forces
        coeff: 1
        metric:
          _target_: nequip.train.RootMeanSquaredError
      - name: peratom_E_RMSE
        field:
          _target_: nequip.data.PerAtomModifier
          field: total_energy
        coeff: 1
        metric:
          _target_: nequip.train.RootMeanSquaredError
      # For monitoring only below:
      # Energy MAE,MSE
      - name: E_MAE
        field: total_energy
        coeff: null
        metric:
          _target_: nequip.train.MeanAbsoluteError
      - name: E_RMSE
        field: total_energy
        coeff: null
        metric:
          _target_: nequip.train.RootMeanSquaredError
      # Force MAE
      - name: F_MAE
        field: forces
        coeff: null
        metric:
          _target_: nequip.train.MeanAbsoluteError
      # Per atom energy MAE
      - name: peratom_E_MAE
        field:
          _target_: nequip.data.PerAtomModifier
          field: total_energy
        coeff: null
        metric:
          _target_: nequip.train.MeanAbsoluteError
      # Per type Force errors:
      - name: F_RMSE_pertype
        field: forces
        coeff: null
        metric:
          _target_: nequip.train.RootMeanSquaredError
        per_type: true
      - name: F_MAE_pertype
        field: forces
        coeff: null
        metric:
          _target_: nequip.train.MeanAbsoluteError
        per_type: true

  test_metrics: ${training_module.val_metrics}

  ema_decay: ${ema_decay}
  optimizer:
    _target_: torch.optim.AdamW
    lr: ${optimizer_lr}
    weight_decay: 0.000001
    amsgrad: ${optimizer_amsgrad}
  lr_scheduler:
    # any torch compatible lr sceduler
    scheduler:
      _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
      factor: ${lr_scheduler_factor}
      patience: ${lr_scheduler_patience}
      threshold: ${lr_scheduler_threshold}
      min_lr: ${lr_scheduler_minlr}
    monitor: val0_epoch/weighted_sum
    interval: epoch
    frequency: 1

  
  model: 
    _target_: nequip.model.ModelFromCheckpoint
    checkpoint_path: /path/to/SPICE-Large-Extend/best.ckpt

# global options
global_options:
  allow_tf32: ${allow_tf32}
